!function(e){var t=function(e){this.initialise(e)};t.prototype=e.extend({},e.fn.arkbase(),{constructor:t,options:{css:{stack:'[data-stack="search"]',control:'[data-action="search"]',toggle:'[data-action-value="toggle"]',preloader:'[data-action-value="preloader"]',field:'[data-action-value="search"]',clearer:'[data-action-value="clear"]',back:".back",path:"[data-stack-control]",templates:{root:"#tmpl-content-search-stack",back:"#tmpl-content-search-back",folder:"#tmpl-content-search-folder",file:"#tmpl-content-search-file"}},data:{path:"data-path",select:"data-select-control"},html:{ajax:"index.php",count:"folders : %s, files : %s",highlight:'<span class="highlight">$1</span>',errors:{malform:"Error!",fail:"Error!",ajax:"No Data!"}},view:{name:null,before:null,after:null,revert:!0},stack:"search",title:"search",namespace:".arksearch",permission:null,animate:300},active:{bar:!1,window:!1},stack:{value:null},results:{term:null,folders:[],files:[]},cache:{},searching:!1,uniqueid:"",el:{root:null,controls:null,toggle:null,preloader:null,field:null,clearer:null},initialise:function(t){return this.set(t),this.permission(this.options.permission)?(this.el.root=e(this.options.css.root),this.el.stack=e(this.options.css.stack),this.el.controls=this.el.root.find(this.options.css.control),this.el.toggle=this.el.root.find(this.options.css.toggle).first(),this.el.preloader=this.el.root.find(this.options.css.preloader).first(),this.el.field=this.el.root.find(this.options.css.field).first(),this.el.clearer=this.el.root.find(this.options.css.clearer).first(),e.views?(this.addControlEvents(),this.setDefault(),this.assets(),this.register(),this.links(),void this.requests()):(this.debug("initialise","Dependent Classes Not Found"),!1)):(this.debug("initialise","Insufficient Search Permissions"),!1)},addControlEvents:function(){e(document).trigger("arksearch:before:add",[this.el.controls]),this.el.root.on("click"+this.options.namespace,this.options.css.toggle,e.proxy(function(t){this.active.bar?e(document).triggerHandler("search:request:bar",{direction:"close"}):e(document).triggerHandler("search:request:bar",{direction:"open"})},this)),this.el.root.on("click"+this.options.namespace,this.options.css.clearer,{options:this.options},function(t){var s=e(this).siblings(t.data.options.css.field),r=s.val();e(document).triggerHandler("search:request:clear"),e(document).triggerHandler("search:request:window",{direction:"close"}),r?s.val("").focus():e(document).triggerHandler("search:request:bar",{direction:"close"})}),this.el.root.on("keyup"+this.options.namespace,this.options.css.field,e.proxy(function(t){var s=e(t.target).val();t.which&&s?(e(document).triggerHandler("search:request:window",{direction:"open"}),e(document).triggerHandler("search:request:title",{text:s}),e(document).triggerHandler("search:request:find",{text:s})):(e(document).triggerHandler("search:request:clear"),e(document).triggerHandler("search:request:window",{direction:"close"}),t.which||this.debug("addControlEvents","Invalid Search Key Entered"))},this)),this.el.root.on("blur"+this.options.namespace,this.options.css.field,function(t){e(t.target).val()||e(document).triggerHandler("search:request:bar",{direction:"close"})}),this.el.stack.on("click"+this.options.namespace,this.options.css.back,function(t){e(document).triggerHandler("search:request:bar",{direction:"close"}),e(document).triggerHandler("search:request:window",{direction:"close"})}),this.el.stack.on("click"+this.options.namespace,this.options.css.path,{self:this,options:this.options},function(t){t.data.self.uniqueid=t.data.self.id();var s=e(this).attr(t.data.options.data.stack),r=e(this).attr(t.data.options.data.path),i=e(this).attr(t.data.options.data.name),o=e(this).attr(t.data.options.data.select),a={stack:s,path:r,item:i,type:o,uniqueid:t.data.self.uniqueid};e(document).triggerHandler("observer:request:load",{stack:s,path:r,options:a})}),e(document).trigger("arksearch:after:add",[this.el.controls])},setDefault:function(){e(document).trigger("arksearch:before:default",[this.el.field]),this.el.field.hide().val(""),this.options.view.before=e(document).triggerHandler("arkcollapse:request:value",{group:this.options.view.name}),this.options.view.before||(this.options.view.before=this.options.view.after),e(document).trigger("arksearch:after:default",[this.el.field])},assets:function(){e(document).trigger("arksearch:before:assets");var t=this;e.views.helpers({getTemplate:function(s){return t.options.css.templates.hasOwnProperty(s)?e.templates(t.options.css.templates[s]):null},search:function(e,s){var r=new RegExp("("+t.escape(s)+")","gi");return e.replace(r,t.options.html.highlight)}},e.templates(this.options.css.templates.root)),e(document).trigger("arksearch:after:assets")},register:function(){e(document).trigger("arksearch:before:register");var t=e.templates(this.options.css.templates.root);t?this.el.stack.link(t,{stack:this.stack,results:this.results}):this.debug("register","Could Not Find Template"),e(document).trigger("arksearch:after:register")},links:function(){var t=e(document).triggerHandler("observer:request:active",{type:"stack"});e.observe(t,"*",e.proxy(function(t,s){s.value===this.options.stack?(e(document).triggerHandler("search:request:bar",{direction:"open"}),e(document).triggerHandler("search:request:window",{direction:"open"}),e.observable(this.stack).setProperty("value",s.oldValue)):e(document).triggerHandler("search:request:window",{direction:"close"})},this))},requests:function(){e(document).on("search:request:bar",e.proxy(function(t,s){if("open"!==s.direction||this.active.bar)"close"===s.direction&&this.active.bar&&(this.el.field.hide(this.options.animate),this.el.clearer.hide(),this.preloader("off"),this.active.bar=!1);else{var r=this.options;this.el.field.show(this.options.animate,function(t){var s=e(this).siblings(r.css.clearer);s&&s.fadeIn(r.animate)}),this.el.field.focus(),this.active.bar=!0}},this)),e(document).on("search:request:window",e.proxy(function(t,s){if("open"!==s.direction||this.active.window)"close"===s.direction&&this.active.window&&(e(document).triggerHandler("observer:request:active",{type:"stack",value:this.stack.value}),e(document).triggerHandler("arkcollapse:request:toggle",{value:this.options.view.before,group:this.options.view.name}),e(document).triggerHandler("arkcollapse:request:state",{type:"on",group:this.options.view.name}),e(document).triggerHandler("upload:request:state",{type:"on"}),e(document).triggerHandler("newfolder:request:state",{type:"on"}),this.active.window=!1);else{e(document).triggerHandler("observer:request:active",{type:"stack"});e(document).triggerHandler("observer:request:active",{type:"stack",value:this.options.stack}),e(document).triggerHandler("arkcollapse:request:toggle",{value:this.options.view.after,group:this.options.view.name}),e(document).triggerHandler("arkcollapse:request:state",{type:"off",group:this.options.view.name}),e(document).triggerHandler("upload:request:state",{type:"off"}),e(document).triggerHandler("newfolder:request:state",{type:"off"}),this.active.window=!0}},this)),e(document).on("search:request:find",e.proxy(function(t,s){if(this.options.html.ajax&&this.stack.value&&s.text){if(this.searching&&"undefined"!=typeof this.searching.abort&&this.searching.abort(),this.cache.hasOwnProperty(this.stack.value)||(this.cache[this.stack.value]={}),this.cache[this.stack.value].hasOwnProperty(s.text))return void this.apply(s.text,this.cache[this.stack.value][s.text]);var r=this;this.searching=e.ajax({type:"post",dataType:"json",url:this.options.html.ajax,data:{stack:this.stack.value,text:s.text},beforeSend:function(e){r.preloader("on")}}).done(function(e){r.searching=!1,r.preloader("off"),e&&"object"==typeof e?(r.cache[r.stack.value][s.text]=e,r.apply(s.text,e)):(r.message(r.options.html.errors.malform,"error",{wink:"slower"}),r.debug("requests","Search Ajax Call Returned Malformed Data."))}).fail(function(e){r.searching=!1,r.preloader("off"),"abort"!==e.statusText&&(r.message(r.options.html.errors.fail,"error",{wink:"slower"}),r.debug("requests","Search Ajax Call Failed."))})}else this.message(this.options.html.errors.ajax,"error",{wink:"slower"}),this.debug("request","Search Failed as the Necessary Data Could Not Found.")},this)),e(document).on("search:request:apply",e.proxy(function(e,t){this.apply(t.text,t.results)},this)),e(document).on("search:request:clear",e.proxy(function(t){e(document).triggerHandler("search:request:title"),e(document).triggerHandler("observer:request:rename",{type:"subtitle",stack:this.options.stack,value:null}),e.observable(this.results).setProperty("term",""),e.observable(this.results.folders).refresh([]),e.observable(this.results.files).refresh([])},this)),e(document).on("observer:request:loaded",e.proxy(function(t,s){s.uniqueid===this.uniqueid&&(e(document).triggerHandler("search:request:link",s),this.uniqueid="")},this)),e(document).on("observer:request:validate",e.proxy(function(e,t){return t&&"root"===t.type&&t.value===this.options.stack?!0:void 0},this)),e(document).on("search:request:link",e.proxy(function(t,s){if(s.type&&s.stack&&s.path&&s.item){e(document).triggerHandler("observer:request:active",{type:"stack",value:s.stack}),e(document).triggerHandler("observer:request:active",{type:"path",stack:s.stack,value:s.path});var r={scrollbar:!0};this.options.view.revert&&(r.view=this.options.view.before),this.highlight(s.type,s.stack,s.path,s.item,r)}},this)),e(document).on("search:request:title",e.proxy(function(t,s){var r=this.options.title;s&&s.text&&(r+=this.options.html.dash+this.options.html.quote.replace(this.options.html.sprintf,s.text)),e(document).triggerHandler("observer:request:rename",{type:"title",stack:this.options.stack,value:r})},this))},apply:function(t,s){e(document).trigger("arksearch:before:apply",[t,s]),e.observable(this.results).setProperty("term",t),e.isArray(s.folders)?e.observable(this.results.folders).refresh(s.folders):e.observable(this.results.folders).refresh([]),e.isArray(s.files)?e.observable(this.results.files).refresh(s.files):e.observable(this.results.files).refresh([]);var r=this.options.html.count.replace(this.options.html.sprintf,s.count.folders).replace(this.options.html.sprintf,s.count.files);e(document).triggerHandler("observer:request:rename",{type:"subtitle",stack:this.options.stack,value:r}),e(document).trigger("arksearch:after:apply",[t,s])},preloader:function(t){e(document).trigger("arksearch:before:preloader",[t]),"on"===t?(this.el.toggle.hide(),this.el.preloader.show()):(this.el.toggle.show(),this.el.preloader.hide()),e(document).trigger("arksearch:after:preloader",[t])}}),e.fn.arkstacksearch=function(e){return new t(e)}}(window.jQuery);